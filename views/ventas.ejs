
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Ventas</title>
  <link rel="stylesheet" href="/ventas.css">
</head>
<body>
  <div class="ventas-dashboard">
    <h2>Gesti√≥n de Ventas</h2>
    <button onclick="mostrarFormulario()">‚ûï Nueva Venta</button>

    <!-- FORMULARIO -->
    <div id="formulario-venta" style="display:none; margin-top: 1rem;">
      <h3 id="form-titulo">Nueva Venta</h3>
      <form id="form-venta" class="ventas-form">
        <input type="hidden" name="_id" id="_id">
        <input name="numeroContrato" id="numeroContrato" placeholder="Contrato" required>
        <input name="nombreCliente" id="nombreCliente" placeholder="Cliente" required>
        <input name="vendedor" id="vendedor" placeholder="Vendedor" required>
        <input type="date" name="fechaVenta" id="fechaVenta">
        <input name="comentario" id="comentario" placeholder="Comentario">
        <input name="departamento" id="departamento" placeholder="Departamento">
        <input name="localidad" id="localidad" placeholder="Localidad">
        <input name="instalacion" id="instalacion" placeholder="Instalaci√≥n">
        <input name="diaHora" id="diaHora" placeholder="D√≠a y Hora">
        <input name="tecnico" id="tecnico" placeholder="T√©cnico">
        <input name="usuarioCarga" id="usuarioCarga" placeholder="Usuario que la carg√≥">
        <input name="promo" id="promo" placeholder="Promo">
        <input name="metodoPago" id="metodoPago" placeholder="M√©todo de pago">
        <input name="canalVenta" id="canalVenta" placeholder="Canal de venta">
        <button type="submit">üíæ Guardar</button>
        <button type="button" onclick="ocultarFormulario()">Cancelar</button>
      </form>
    </div>

    <!-- LISTADO -->
    <table class="ventas-table">
      <thead>
        <tr>
          <th>Contrato</th><th>Cliente</th><th>Vendedor</th><th>Fecha</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-ventas">
        <% ventas.forEach(v => { %>
          <tr>
            <td><%= v.numeroContrato %></td>
            <td><%= v.nombreCliente %></td>
            <td><%= v.vendedor %></td>
            <td><%= v.fechaVenta?.toLocaleDateString() %></td>
            <td>
              <button onclick='editarVenta(<%- JSON.stringify(v) %>)'>‚úèÔ∏è</button>
              <form action="/ventas/eliminar/<%= v._id %>" method="POST" style="display:inline;">
                <button type="submit" onclick="return confirm("¬øEliminar venta?")">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <script>
    function mostrarFormulario() {
      document.getElementById("formulario-venta").style.display = "block";
      document.getElementById("form-titulo").textContent = "Nueva Venta";
      document.getElementById("form-venta").reset();
      document.getElementById("_id").value = "";
    }

    function ocultarFormulario() {
      document.getElementById("formulario-venta").style.display = "none";
    }

    function editarVenta(venta) {
      mostrarFormulario();
      document.getElementById("form-titulo").textContent = "Editar Venta";
      for (let key in venta) {
        if (document.getElementById(key)) {
          if (key === 'fechaVenta' && venta[key]) {
            document.getElementById(key).value = new Date(venta[key]).toISOString().split('T')[0];
          } else {
            document.getElementById(key).value = venta[key];
          }
        }
      }
    }

    document.getElementById("form-venta").onsubmit = async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const json = Object.fromEntries(formData.entries());

      const res = await fetch("/ventas/guardar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
      });

      if (res.ok) {
        location.reload();
      } else {
        alert("Error al guardar");
      }
    };
  </script>
</body>
</html>
