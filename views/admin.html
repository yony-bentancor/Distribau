<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador | Componentes y Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 1rem;
      margin: 0;
      background: #f0f2f5;
      color: #333;
    }
    h2, h3 { text-align: center; margin-top: 1rem; }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 1rem;
    }
    form {
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    input, select, button {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background-color: #004c99; }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 0.8rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th { background-color: #f7f7f7; }
    td button {
      margin-right: 5px;
      padding: 5px 10px;
      font-size: 0.9rem;
      border-radius: 4px;
    }
    td button:first-child {
      background-color: #ffc107;
      color: black;
      border: none;
    }
    td button:last-child {
      background-color: #dc3545;
      color: white;
      border: none;
    }
    #alerta {
      display: none;
      margin: 1rem auto;
      padding: 1rem;
      max-width: 400px;
      text-align: center;
      font-weight: bold;
      border-radius: 5px;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      th { display: none; }
      td {
        position: relative;
        padding-left: 50%;
        margin-bottom: 1rem;
      }
      td::before {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-weight: bold;
      }
      td:nth-child(1)::before { content: "Nombre"; }
      td:nth-child(2)::before { content: "Puntaje"; }
      td:nth-child(3)::before { content: "Acciones"; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Crear nuevo componente</h2>
  <div id="alerta"></div>
  <form id="form-componente">
    <input type="text" name="nombre" placeholder="Nombre del componente" required>
    <input type="number" name="puntaje" step="0.01" placeholder="Puntaje" required>
    <button type="submit">Guardar</button>
  </form>

  <h2>Listado de componentes</h2>
  <table id="tabla-componentes">
    <thead>
    <tr>
      <th>Nombre</th>
      <th>Puntaje</th>
      <th>Acciones</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Transferencia de stock a t√©cnicos</h2>
  <form id="form-transferencia">
    <select id="tecnico" name="tecnico" required></select>
    <select id="componente" name="componente" required></select>
    <input type="number" name="cantidad" id="cantidad" min="1" required>
    <button type="submit">Transferir stock</button>
  </form>

  <h3>Bodegas por t√©cnico</h3>
  <div id="bodegas-tecnicos"></div>
</div>

<script>
  function mostrarAlerta(mensaje, tipo = "success") {
    const alerta = document.getElementById("alerta");
    alerta.innerText = mensaje;
    alerta.style.display = "block";
    alerta.style.backgroundColor = tipo === "success" ? "#d4edda" : "#f8d7da";
    alerta.style.color = tipo === "success" ? "#155724" : "#721c24";
    alerta.style.border = tipo === "success" ? "1px solid #c3e6cb" : "1px solid #f5c6cb";
    setTimeout(() => alerta.style.display = "none", 3000);
  }

  async function cargarComponentes() {
  const res = await fetch("/componentes");
  const componentes = await res.json();

  const tbody = document.querySelector("#tabla-componentes tbody");
  tbody.innerHTML = "";

  componentes.forEach((c) => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${c.nombre}</td>
      <td>${c.puntaje}</td>
      <td>
        <input type="number" step="1" min="0" id="stock-${c._id}" value="${c.stock || 0}" style="width:80px;"> 
        <button onclick="guardarStockCentral('${c._id}')">üíæ</button>
      </td>
      <td>
        <button onclick="editarComponente('${c._id}', '${c.nombre}', ${c.puntaje})">Editar</button>
        <button onclick="eliminarComponente('${c._id}')">Eliminar</button>
      </td>
    `;
    tbody.appendChild(fila);
  });
}
async function guardarStockCentral(id) {
  const input = document.getElementById(`stock-${id}`);
  const nuevoStock = parseInt(input.value);

  if (isNaN(nuevoStock) || nuevoStock < 0) {
    mostrarAlerta("‚ùå Stock inv√°lido", "error");
    return;
  }

  const res = await fetch(`/actualizar-stock-central/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ stock: nuevoStock })
  });

  if (res.ok) {
    mostrarAlerta("‚úÖ Stock central actualizado");
    cargarTecnicosYComponentes();
    cargarBodegasUsuarios();
  } else {
    const msg = await res.text();
    mostrarAlerta("‚ö†Ô∏è " + msg, "error");
  }
}



  async function eliminarComponente(id) {
    if (confirm("¬øEliminar este componente?")) {
      await fetch(`/componentes/${id}`, { method: "DELETE" });
      mostrarAlerta("üóëÔ∏è Componente eliminado");
      cargarComponentes();
    }
  }

  function editarComponente(id, nombre, puntaje) {
    const nuevoNombre = prompt("Nuevo nombre:", nombre);
    const nuevoPuntaje = prompt("Nuevo puntaje:", puntaje);
    const puntajeFloat = parseFloat(nuevoPuntaje);
    if (!isNaN(puntajeFloat) && nuevoNombre) {
      fetch(`/componentes/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre: nuevoNombre, puntaje: puntajeFloat }),
      }).then(() => {
        mostrarAlerta("‚úÖ Componente actualizado correctamente");
        cargarComponentes();
      });
    } else {
      mostrarAlerta("‚ùå Datos inv√°lidos", "error");
    }
  }

  async function cargarTecnicosYComponentes() {
    const [tecnicosRes, componentesRes] = await Promise.all([
      fetch("/usuarios-tecnicos"),
      fetch("/componentes")
    ]);
    const tecnicos = await tecnicosRes.json();
    const componentes = await componentesRes.json();

    const tecnicoSelect = document.getElementById("tecnico");
    const componenteSelect = document.getElementById("componente");

    tecnicoSelect.innerHTML = "";
    componenteSelect.innerHTML = "";

    tecnicos.forEach((t) => {
      const option = document.createElement("option");
      option.value = t._id;
      option.textContent = t.username;
      tecnicoSelect.appendChild(option);
    });

    componentes.forEach((c) => {
      const option = document.createElement("option");
      option.value = c._id;
      option.textContent = `${c.nombre} (Stock: ${c.stock})`;
      componenteSelect.appendChild(option);
    });
  }

  async function cargarBodegasUsuarios() {
    const res = await fetch("/bodegas-usuarios");
    const bodegas = await res.json();
    const contenedor = document.getElementById("bodegas-tecnicos");
    contenedor.innerHTML = "";
    bodegas.forEach((b) => {
      const div = document.createElement("div");
      div.style.marginBottom = "1rem";
      div.style.background = "#fff";
      div.style.padding = "1rem";
      div.style.borderRadius = "10px";
      div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.05)";
      let html = `<strong>${b.usuario.username}</strong><ul>`;
      b.componentes.forEach((c) => {
        html += `<li>${c.componente.nombre}: ${c.cantidad}</li>`;
      });
      html += "</ul>";
      div.innerHTML = html;
      contenedor.appendChild(div);
    });
  }

  document.getElementById("form-componente").addEventListener("submit", async function (e) {
    e.preventDefault();
    const nombre = this.nombre.value.trim();
    const puntaje = parseFloat(this.puntaje.value);
    if (!nombre || isNaN(puntaje)) return mostrarAlerta("‚ùå Datos inv√°lidos", "error");
    const res = await fetch("/componentes", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ nombre, puntaje }),
    });
    if (res.ok) {
      mostrarAlerta("‚úÖ Componente creado correctamente");
      this.reset();
      cargarComponentes();
      cargarTecnicosYComponentes();
    } else {
      const msg = await res.text();
      mostrarAlerta("‚ö†Ô∏è " + msg, "error");
    }
  });

  document.getElementById("form-transferencia").addEventListener("submit", async function (e) {
    e.preventDefault();
    const userId = this.tecnico.value;
    const componenteId = this.componente.value;
    const cantidad = parseInt(this.cantidad.value);
    if (!userId || !componenteId || isNaN(cantidad) || cantidad <= 0) return mostrarAlerta("‚ùå Datos inv√°lidos", "error");
    const res = await fetch("/transferir-stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, componenteId, cantidad })
    });
    if (res.ok) {
      mostrarAlerta("üì¶ Stock transferido correctamente");
      cargarComponentes();
      cargarTecnicosYComponentes();
      cargarBodegasUsuarios();
      this.reset();
    } else {
      const msg = await res.text();
      mostrarAlerta("‚ö†Ô∏è " + msg, "error");
    }
  });

  window.onload = () => {
    cargarComponentes();
    cargarTecnicosYComponentes();
    cargarBodegasUsuarios();
  };
</script>
</body>
</html>
