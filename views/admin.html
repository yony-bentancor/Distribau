<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador | Componentes y Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 1rem;
      margin: 0;
      background: #f0f2f5;
      color: #333;
    }
    h2, h3 { text-align: center; margin-top: 1rem; }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 1rem;
    }
    form {
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    input, select, button {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background-color: #004c99; }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 0.8rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th { background-color: #f7f7f7; }
    td button {
      margin-right: 5px;
      padding: 5px 10px;
      font-size: 0.9rem;
      border-radius: 4px;
    }
    td button:first-child {
      background-color: #ffc107;
      color: black;
      border: none;
    }
    td button:last-child {
      background-color: #dc3545;
      color: white;
      border: none;
    }
    #alerta {
      display: none;
      margin: 1rem auto;
      padding: 1rem;
      max-width: 400px;
      text-align: center;
      font-weight: bold;
      border-radius: 5px;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      th { display: none; }
      td {
        position: relative;
        padding-left: 50%;
        margin-bottom: 1rem;
      }
      td::before {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-weight: bold;
      }
      td:nth-child(1)::before { content: "Nombre"; }
      td:nth-child(2)::before { content: "Puntaje"; }
      td:nth-child(3)::before { content: "Acciones"; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Crear nuevo componente</h2>
  <div id="alerta"></div>
  <form id="form-componente">
    <input type="text" name="nombre" placeholder="Nombre del componente" required>
    <input type="number" name="puntaje" step="0.01" placeholder="Puntaje" required>
    <button type="submit">Guardar</button>
  </form>
<a href="/historial" target="_blank" style="display:block;margin-top:2rem;text-align:center;">üìñ Ver historial de movimientos</a>

  <h2>Listado de componentes</h2>
  <table id="tabla-componentes">
    <thead>
    <tr>
      <th>Nombre</th>
    
      <th>STOCK EN BODEGA</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Bodegas por t√©cnico</h3>
<div id="bodegas-tecnicos"></div>


<h2>Transferencia de stock</h2>
<form id="form-transferencia-multiple">

  <label>Origen</label>
  <select id="origen" required>
    <option value="bodega_central">Bodega Central</option>
    <!-- t√©cnicos se cargan din√°micamente -->
  </select>

  <label>Destino</label>
  <select id="destino" required>
    <!-- t√©cnicos se cargan din√°micamente -->
  </select>

  <div id="componentes-transferencia">
    <!-- aqu√≠ van los campos din√°micos -->
  </div>

  <button type="button" onclick="agregarLineaComponente()">‚ûï Agregar Componente</button>
  <br><br>
  <textarea id="comentario" placeholder="Comentario (opcional)" rows="2" style="width:100%"></textarea>
  <button type="submit">Transferir</button>
</form>

</div>

<script>
  function mostrarAlerta(mensaje, tipo = "success") {
    const alerta = document.getElementById("alerta");
    alerta.innerText = mensaje;
    alerta.style.display = "block";
    alerta.style.backgroundColor = tipo === "success" ? "#d4edda" : "#f8d7da";
    alerta.style.color = tipo === "success" ? "#155724" : "#721c24";
    alerta.style.border = tipo === "success" ? "1px solid #c3e6cb" : "1px solid #f5c6cb";
    setTimeout(() => alerta.style.display = "none", 3000);
  }

  async function cargarComponentes() {
    const res = await fetch("/componentes");
    const componentes = await res.json();

    const tbody = document.querySelector("#tabla-componentes tbody");
    tbody.innerHTML = "";

    componentes.forEach((c) => {
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${c.nombre}</td>
   
        <td>
          <input type="number" step="1" min="0" id="stock-${c._id}" value="${c.stock || 0}" style="width:80px;"> 
          <button onclick="guardarStockCentral('${c._id}')">üíæ</button>
        </td>
        <td>
          <button onclick="editarComponente('${c._id}', '${c.nombre}', ${c.puntaje})">Editar</button>
          <button onclick="eliminarComponente('${c._id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(fila);
    });
  }

  async function guardarStockCentral(id) {
    const input = document.getElementById(`stock-${id}`);
    const nuevoStock = parseInt(input.value);

    if (isNaN(nuevoStock) || nuevoStock < 0) {
      mostrarAlerta("‚ùå Stock inv√°lido", "error");
      return;
    }

    const res = await fetch(`/actualizar-stock-central/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ stock: nuevoStock })
    });

    if (res.ok) {
      mostrarAlerta("‚úÖ Stock central actualizado");
      cargarTecnicosParaTransferencia();
      cargarBodegasUsuarios();
    } else {
      const msg = await res.text();
      mostrarAlerta("‚ö†Ô∏è " + msg, "error");
    }
  }

  async function eliminarComponente(id) {
    if (confirm("¬øEliminar este componente?")) {
      await fetch(`/componentes/${id}`, { method: "DELETE" });
      mostrarAlerta("üóëÔ∏è Componente eliminado");
      cargarComponentes();
    }
  }

  function editarComponente(id, nombre, puntaje) {
    const nuevoNombre = prompt("Nuevo nombre:", nombre);
    const nuevoPuntaje = prompt("Nuevo puntaje:", puntaje);
    const puntajeFloat = parseFloat(nuevoPuntaje);
    if (!isNaN(puntajeFloat) && nuevoNombre) {
      fetch(`/componentes/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre: nuevoNombre, puntaje: puntajeFloat }),
      }).then(() => {
        mostrarAlerta("‚úÖ Componente actualizado correctamente");
        cargarComponentes();
      });
    } else {
      mostrarAlerta("‚ùå Datos inv√°lidos", "error");
    }
  }

async function cargarBodegasUsuarios() {
  const res = await fetch("/bodegas-usuarios");
  const bodegas = await res.json();
  const contenedor = document.getElementById("bodegas-tecnicos");
  contenedor.innerHTML = "";

  bodegas.forEach((b) => {
    const div = document.createElement("div");
    div.style.marginBottom = "1.5rem";
    div.style.background = "#fff";
    div.style.padding = "1rem";
    div.style.borderRadius = "10px";
    div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.05)";
    div.style.borderLeft = "6px solid #0066cc";

    let html = `<h4>üë∑ ${b.usuario.username}</h4>`;
    if (b.componentes.length === 0) {
      html += "<p style='color:#999;'>Sin componentes</p>";
    } else {
      html += "<ul>";
      b.componentes.forEach((c) => {
        html += `<li>${c.componente.nombre}: <strong>${c.cantidad}</strong></li>`;
      });
      html += "</ul>";
    }

    div.innerHTML = html;
    contenedor.appendChild(div);
  });
}



  // ---------------- NUEVO SISTEMA DE TRANSFERENCIA M√öLTIPLE ----------------

  let todosLosComponentes = [];

  async function cargarTecnicosParaTransferencia() {
    const res = await fetch("/usuarios-tecnicos");
    const tecnicos = await res.json();

    const origen = document.getElementById("origen");
    const destino = document.getElementById("destino");

   origen.innerHTML = `<option value="bodega_central">Bodega Central</option>`;
  destino.innerHTML = `<option value="bodega_central">Bodega Central</option>`; // <-- agreg√° esta l√≠nea


    tecnicos.forEach((t) => {
      const opt = new Option(t.username, t._id);
      origen.appendChild(opt.cloneNode(true));
      destino.appendChild(opt);
    });
  }

  async function agregarLineaComponente() {
    if (todosLosComponentes.length === 0) {
      const res = await fetch("/componentes");
      todosLosComponentes = await res.json();
    }

    const div = document.createElement("div");
    div.innerHTML = `
      <select class="select-componente" required>
        ${todosLosComponentes.map(c => `<option value="${c._id}">${c.nombre}(Stock: ${c.stock ?? 0})</option>`).join("")}   
      
      </select>
      <input type="number" min="1" class="cantidad-componente" placeholder="Cantidad" required style="width:100px;">
      <button type="button" onclick="this.parentNode.remove()">‚ùå</button>
    `;
    document.getElementById("componentes-transferencia").appendChild(div);
  }

  document.getElementById("form-transferencia-multiple").addEventListener("submit", async function (e) {
    e.preventDefault();

    const origenValor = document.getElementById("origen").value;
    const destinoValor = document.getElementById("destino").value;
    const comentario = document.getElementById("comentario").value;

    if (origenValor === destinoValor) {
      return mostrarAlerta("‚ùå Origen y destino no pueden ser iguales", "error");
    }

    const origen = origenValor === "bodega_central" ? { tipo: "bodega", id: null } : { tipo: "usuario", id: origenValor };
    const destino = destinoValor === "bodega_central" ? { tipo: "bodega", id: null } : { tipo: "usuario", id: destinoValor };

    const selects = document.querySelectorAll(".select-componente");
    const cantidades = document.querySelectorAll(".cantidad-componente");

    const componentes = [];
    for (let i = 0; i < selects.length; i++) {
      const componenteId = selects[i].value;
      const cantidad = parseInt(cantidades[i].value);
      if (!componenteId || isNaN(cantidad) || cantidad <= 0) {
        return mostrarAlerta("‚ùå Datos inv√°lidos en la selecci√≥n de componentes", "error");
      }
      componentes.push({ componenteId, cantidad });
    }

    if (componentes.length === 0) {
      return mostrarAlerta("‚ùå Debes agregar al menos un componente", "error");
    }

    const res = await fetch("/transferir", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ origen, destino, componentes, comentario })
    });

    if (res.ok) {
      mostrarAlerta("‚úÖ Transferencia realizada con √©xito");
      cargarComponentes();
      cargarTecnicosParaTransferencia();
      cargarBodegasUsuarios();
      this.reset();
      document.getElementById("componentes-transferencia").innerHTML = "";
    } else {
      const msg = await res.text();
      mostrarAlerta("‚ö†Ô∏è " + msg, "error");
    }
  });

  window.onload = () => {
    cargarComponentes();
    cargarTecnicosParaTransferencia();
    cargarBodegasUsuarios();
  };
</script>

</body>
</html>
